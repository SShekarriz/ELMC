---
title: "paper figures"
output: html_document
date: "2025-07-13"
---

```{r}

library(tidyverse)
library(ggpubr)
library(cowplot)
library(ape)
library(ggtree)      # For tree visualization and gheatmap
library(treeio)      # For reading tree files (e.g., Newick format)
library(aplot) # For aligning plots

library(forcats)
library(pheatmap)

#load functions
source('./functions.R')

```

## Bins

```{r}

CountFig(feature_c = "../data/clean/binCover.txt",
           cutoff_pres = 75,
           method = "Assembly",
           mapfile = "../data/clean/mapfile.txt")

CountFig(feature_c = "../data/clean/binCover.txt",
           cutoff_pres = 75,
           method = "Assembly",
           mapfile = "../data/clean/mapfile.txt") +
  facet_grid(Donor~., space = "free", scales = "free")




```

```{r}

CompFig(feature_c = "../data/clean/binCover.txt",
           cutoff_pres = 75,
           method = "Assembly",
           mapfile = "../data/clean/mapfile.txt") 


```

## MAGs

```{r}

CountFig(feature_c = "../data/clean/MAGCover.txt",
           cutoff_pres = 75,
           method = "Assembly",
           mapfile = "../data/clean/mapfile.txt") 

```

```{r}

CompFig(feature_c = "../data/clean/MAGCover.txt",
           cutoff_pres = 75,
           method = "Assembly",
           mapfile = "../data/clean/mapfile.txt")

```


```{r}

CompFigWithTree(feature_c = "../data/clean/MAGCover.txt",
                cutoff_pres = 75,
                method = "Assembly",
                mapfile = "../data/clean/mapfile.txt",
                treeA_file = "../data/clean/MAGs_DonA.tree")


```


```{r}

feature_c = "../data/clean/MAGCover.txt"
cutoff_pres = 75
method = "Assembly"
mapfile = "../data/clean/mapfile.txt"

  # DonorA
  donorA_feature <- DonFeature(feature_c = feature_c, donor = "DonA",
                               cutoff_pres = cutoff_pres, method = method)
  finalA_identity <- identColoniz(donor_feature = donorA_feature, 
                               cutoff_pres = cutoff_pres,
                               mapfile = mapfile) %>%
                    mutate(Donor = paste("DonorA"))
  # DonorB
  donorB_feature <- DonFeature(feature_c = feature_c, donor = "DonB",
                               cutoff_pres = cutoff_pres, method = method)
  finalB_identity <- identColoniz(donor_feature = donorB_feature, 
                                  cutoff_pres = cutoff_pres,
                                  mapfile = mapfile) %>%
                    mutate(Donor = paste("DonorB"))
  
  table <- finalA_identity %>%
    rbind(finalB_identity) 
  
  table %>%
    distinct(feature, Donor) -> test
  

```








```{r}

CompFigWithTree_pheatmap(feature_c = "../data/clean/MAGCover.txt",
                cutoff_pres = 75,
                method = "Assembly",
                mapfile = "../data/clean/mapfile.txt")


```



## Genes

```{r}

CountFig(feature_c = "../data/clean/geneCover.txt",
           cutoff_pres = 90,
           method = "Assembly",
           mapfile = "../data/clean/mapfile.txt") 

```

```{r}

CompFig(feature_c = "../data/clean/geneCover.txt",
           cutoff_pres = 90,
           method = "Assembly",
           mapfile = "../data/clean/mapfile.txt") 


```

## Species

```{r}

CountFig(feature_c = "../data/clean/speciesAbund.txt",
           cutoff_pres = 0.001,
           method = "Reads",
           mapfile = "../data/clean/mapfile.txt") 

```

```{r}

CompFig(feature_c = "../data/clean/speciesAbund.txt",
           cutoff_pres = 0.001,
           method = "Reads",
           mapfile = "../data/clean/mapfile.txt") 


```


## colonization stats model

```{r}

library(lme4)
library(lmerTest)

#load mapfile
mapfile <- read.csv("../data/clean/mapfile.txt", sep = "\t")
mapfile %>%
  distinct(Sample, Cage) -> mapfile

# load the data
coloniz <- read.csv("../data/clean/coloniz_counts.txt",
                    sep = "\t")
coloniz <- coloniz %>%
  filter(Group %in% c("AB", "BA", "ABAB")) %>%
  left_join(mapfile)

# Z-score normalization of n_coloniz within each feature type
df <- coloniz %>%
  group_by(feature, Donor) %>%
  mutate(n_coloniz_z = scale(n_coloniz)) %>%
  ungroup()

# Visualize the data:
df %>%
  group_by(Group, Donor, feature) %>%
  summarise(mean_colonization = mean(n_coloniz_z), .groups = "drop") %>%
  arrange(Group, Donor)

ggplot(df, aes(x = Group, y = n_coloniz_z, fill = Donor)) +
  geom_boxplot() +
  facet_wrap(~feature) +
  scale_color_manual(values = c("DonorA" = "#7b3294",
                                  "DonorB" = "#008837")) +
  scale_fill_manual(values = c("DonorA" = "#7b3294",
                                  "DonorB" = "#008837")) +
  theme_classic()


#mixed mode:
model <- lmer(n_coloniz_z ~ Group*Donor*feature + (1 | Sample) + (1 | Cage),
                  data = df)

resd_df = data.frame(resid = resid(model),
                     pred = predict(model))
ggplot(resd_df, aes(sample = resid)) +
  geom_qq() +
  geom_qq_line()

ggplot(resd_df, aes(x = pred, y = resid)) +
  geom_point() +
  geom_smooth()

ggplot(resd_df, aes(x = pred, y = abs(resid))) +
  geom_point() +
  geom_smooth()


```







